name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run unit tests
      run: npm run test:unit

  integration-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Download and setup Zenoh remote-api plugin
      run: |
        mkdir -p zenoh_plugins/lib
        cd zenoh_plugins/lib

        # Download the remote-api plugin (x86_64-unknown-linux-musl for Docker compatibility)
        # Use curl with -L to follow redirects from Eclipse download server
        curl -L -o plugin.zip "https://download.eclipse.org/zenoh/zenoh-plugin-remote-api/1.6.2/zenoh-ts-1.6.2-x86_64-unknown-linux-musl-standalone.zip"

        # Extract the plugin
        unzip -q plugin.zip

        # Verify plugin was extracted
        ls -la
        cd ../..

    - name: Start Zenoh router with WebSocket support (remote-api plugin)
      run: |
        # Start Zenoh router v1.6.2 with remote-api plugin for WebSocket connections
        # The remote-api plugin is required for zenoh-ts library to connect
        docker run -d --name zenoh-router \
          -p 7447:7447 \
          -p 8000:8000 \
          -p 10000:10000 \
          -v $(pwd)/zenoh_plugins:/root/.zenoh \
          eclipse/zenoh:1.6.2 \
          --cfg='mode:"router"' \
          --cfg='listen:["tcp/0.0.0.0:7447"]' \
          --cfg='plugins/rest/http_port:"0.0.0.0:8000"' \
          --cfg='plugins/remote_api/websocket_port:"0.0.0.0:10000"'

        # Wait for router and plugin to be ready
        echo "Waiting for Zenoh router with remote-api plugin to start..."
        sleep 15

        # Verify router is running
        docker ps | grep zenoh-router

    - name: Check Zenoh router status
      run: |
        echo "=== Docker container status ==="
        docker ps -a
        echo ""
        echo "=== Zenoh router logs ==="
        docker logs zenoh-router || true
        echo ""
        echo "=== Testing REST API (port 8000) ==="
        curl -v http://localhost:8000/@/router/local 2>&1 | head -20 || echo "REST API not responding"
        echo ""
        echo "=== Testing WebSocket port (10000) ==="
        if timeout 2 bash -c "</dev/tcp/localhost/10000" 2>/dev/null; then
          echo "✓ Port 10000 is open and accepting connections"
        else
          echo "✗ Port 10000 is not accessible from host"
          exit 1
        fi
        echo ""
        echo "=== Checking listening ports inside container ==="
        docker exec zenoh-router sh -c "netstat -tlnp 2>/dev/null || ss -tlnp" | grep -E "(8000|10000|7447)" || echo "netstat/ss not available"

    - name: Run integration tests
      run: npm run test:integration

    - name: Show Zenoh logs on failure
      if: failure()
      run: |
        echo "=== Full Zenoh router logs ==="
        docker logs zenoh-router
        echo ""
        echo "=== Container details ==="
        docker inspect zenoh-router

  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check for common issues
      run: |
        echo "Checking for syntax errors..."
        node -c nodes/*.js
        echo "All syntax checks passed!"
